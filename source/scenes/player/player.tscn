[gd_scene format=3 uid="uid://cxk27w5ficlco"]

[ext_resource type="Script" uid="uid://bvt0l60nmgv4s" path="res://scripts/player/player_controller.gd" id="1_rkuj1"]
[ext_resource type="Script" uid="uid://v23xafiwc0lo" path="res://scripts/input/input_gather.gd" id="2_0owmy"]
[ext_resource type="Texture2D" uid="uid://l2m8nhv330ad" path="res://assets/textures/Warm Autumn Glow.png" id="2_cnsyf"]
[ext_resource type="Material" uid="uid://cw3vtka5voiak" path="res://assets/materials/dither.tres" id="2_h17s1"]
[ext_resource type="Script" uid="uid://0x2i8kdr51fu" path="res://scripts/camera/camera_movement.gd" id="2_qek5x"]
[ext_resource type="Script" uid="uid://cu4pxvtbu3ogn" path="res://scripts/camera/dynamic_sway_recoil.gd" id="3_ioxgp"]
[ext_resource type="Script" uid="uid://dlyn7myxb1v18" path="res://scripts/statemachine/statemachine.gd" id="5_5tt2p"]
[ext_resource type="PackedScene" uid="uid://dg7xl4dtseqsv" path="res://scenes/outline_pixelate.tscn" id="5_kvlxm"]
[ext_resource type="Shader" uid="uid://dcxcwwd03jc52" path="res://assets/shaders/dither.gdshader" id="5_uniwh"]
[ext_resource type="Script" uid="uid://c5cfuh8tg3iw5" path="res://scripts/camera/hand_camera.gd" id="6_fm80t"]
[ext_resource type="Texture2D" uid="uid://cylbyfrmd61vp" path="res://assets/textures/noise.tres" id="6_iqsei"]
[ext_resource type="Script" uid="uid://bs6sc1frb1nfc" path="res://scripts/player/ground/idle.gd" id="6_rkuj1"]
[ext_resource type="Script" uid="uid://b01bw7djd0wvp" path="res://scripts/player/ground/walk.gd" id="7_ers80"]
[ext_resource type="Texture2D" uid="uid://dq5n5sbu2xmbt" path="res://assets/textures/flame_single.png" id="7_tffgl"]
[ext_resource type="Script" uid="uid://dmw47mb382ebt" path="res://scripts/player/ground/jump.gd" id="8_nwn0c"]
[ext_resource type="Texture2D" uid="uid://bxpmsw3vi1crh" path="res://assets/textures/smoke.png" id="8_pk8ii"]
[ext_resource type="Script" uid="uid://brdohbduwyyb6" path="res://scripts/player/ground/fall.gd" id="9_y4pjd"]
[ext_resource type="Script" uid="uid://vptqvkhe206v" path="res://scripts/player/ground/crouch.gd" id="12_lgqa7"]
[ext_resource type="Material" uid="uid://sieciuw0oa22" path="res://assets/materials/screen_pixel.tres" id="15_fcs02"]
[ext_resource type="AudioStream" uid="uid://4u5ivtiif5oj" path="res://assets/sounds/step 1.mp3" id="16_lgqa7"]
[ext_resource type="Shader" uid="uid://nnm2vfpswuif" path="res://assets/shaders/canvas_pixel.gdshader" id="16_myrg7"]
[ext_resource type="AudioStream" uid="uid://doan5eyctitrk" path="res://assets/sounds/step 2.mp3" id="17_8ydkj"]
[ext_resource type="AudioStream" uid="uid://cbwsjme7v7t55" path="res://assets/sounds/step 3.mp3" id="18_3j4b4"]
[ext_resource type="Script" uid="uid://bdnt7gg01aapm" path="res://scripts/player/ground/run.gd" id="18_cnsyf"]
[ext_resource type="PackedScene" uid="uid://bchalkxryrgfy" path="res://scenes/torch.tscn" id="19_ioxgp"]
[ext_resource type="AudioStream" uid="uid://y8ma5gjdshwm" path="res://assets/sounds/step 4.mp3" id="19_yj68g"]
[ext_resource type="Script" uid="uid://dmnvhxj0y77t2" path="res://scripts/steps.gd" id="20_8ydkj"]
[ext_resource type="PackedScene" uid="uid://w0e5qalsukw6" path="res://scenes/chalk_item.tscn" id="22_cnsyf"]
[ext_resource type="Script" uid="uid://rjx8njkfeek4" path="res://scripts/post_process/canvas_pixel_dither_world.gd" id="23_canvas_dither"]

[sub_resource type="Environment" id="Environment_ugbui"]
tonemap_mode = 4
glow_normalized = true
glow_bloom = 0.33
fog_mode = 1
fog_light_color = Color(0, 0, 0, 1)
fog_light_energy = 0.0
fog_density = 1.0
volumetric_fog_density = 0.25
volumetric_fog_albedo = Color(0, 0, 0, 1)
adjustment_color_correction = ExtResource("2_cnsyf")

[sub_resource type="ShaderMaterial" id="ShaderMaterial_gybtl"]
render_priority = 1
shader = ExtResource("5_uniwh")
shader_parameter/texture_albedo = ExtResource("7_tffgl")
shader_parameter/lit_color = Color(1, 1, 1, 1)
shader_parameter/normal_scale = 1.0
shader_parameter/shadow_color = Color(1, 1, 1, 1)
shader_parameter/use_gradient = false
shader_parameter/use_inverse_gradient = false
shader_parameter/color_depth = 8.0000003325
shader_parameter/roughness_scale = 1.0
shader_parameter/use_transparency = true
shader_parameter/alpha_threshold = 0.2010000095475
shader_parameter/cull_mode = 2
shader_parameter/use_dithered_transparency = true
shader_parameter/opacity = 0.246000011685
shader_parameter/billboard_mode = 1
shader_parameter/no_outlines = true
shader_parameter/dither_type = 2
shader_parameter/dither_mode = 0
shader_parameter/dither_pixel_size = 2.0
shader_parameter/dither_density = 128.0
shader_parameter/world_dither_density = 32.0
shader_parameter/dither_spread = 0.91500004276398
shader_parameter/shadow_bias = 0.06400005054000002
shader_parameter/blue_noise_texture = ExtResource("6_iqsei")
shader_parameter/albedo_mapping = 0
shader_parameter/uv_scale = Vector2(1, 1)
shader_parameter/uv_offset = Vector2(0, 0)
shader_parameter/global_ambient = Color(0, 0.014809188, 0.015851432, 1)
shader_parameter/light_boost = 1.0
shader_parameter/bounce_strength = 0.0

[sub_resource type="Curve" id="Curve_x1r1x"]
_data = [Vector2(0, 1), 0.0, 0.0, 0, 0, Vector2(1, 0), 0.0, 0.0, 0, 0]
point_count = 2

[sub_resource type="CurveTexture" id="CurveTexture_o1df0"]
curve = SubResource("Curve_x1r1x")

[sub_resource type="ParticleProcessMaterial" id="ParticleProcessMaterial_21l5o"]
lifetime_randomness = 1.0
emission_shape = 1
emission_sphere_radius = 0.06
radial_velocity_min = -0.10002235
radial_velocity_max = 0.09997764
gravity = Vector3(0, 1, 0)
tangential_accel_min = -0.10000224
tangential_accel_max = 0.09999776
scale_min = 0.25
scale_max = 0.75
scale_over_velocity_max = 10.0
scale_over_velocity_curve = SubResource("CurveTexture_o1df0")
turbulence_noise_speed_random = 0.77
turbulence_influence_max = 0.149
collision_mode = 2
collision_use_scale = true

[sub_resource type="QuadMesh" id="QuadMesh_wjrvc"]

[sub_resource type="Shader" id="Shader_wjrvc"]
code = "shader_type spatial;
render_mode blend_mix, depth_draw_opaque, cull_disabled;

// --- COLOR & PALETTE ---
group_uniforms Color_Style;
uniform sampler2D texture_albedo : source_color, filter_nearest;
uniform vec3 lit_color : source_color = vec3(1.0, 1.0, 1.0);

group_uniforms Normal_Map;
uniform sampler2D texture_normal : hint_normal, filter_nearest;
uniform float normal_scale : hint_range(-16.0, 16.0) = 1.0;
uniform vec3 shadow_color : source_color = vec3(0.0, 0.0, 0.0);
uniform sampler2D color_gradient : source_color;
uniform bool use_gradient = false;
uniform bool use_inverse_gradient = false;
// Amount of colors/bands
uniform float color_depth : hint_range(1.0, 256.0) = 32.0;

group_uniforms Roughness;
uniform sampler2D texture_roughness : hint_roughness_r, filter_nearest;
uniform float roughness_scale : hint_range(0.0, 1.0) = 1.0;

// --- TRANSPARENCY ---
group_uniforms Transparency;
uniform bool use_transparency = false;
uniform float alpha_threshold : hint_range(0.0, 1.0) = 0.5;
uniform int cull_mode : hint_enum(\"Back\", \"Front\", \"Disabled\") = 0;
uniform bool use_dithered_transparency = false;
uniform float opacity : hint_range(0.0, 1.0) = 1.0;

group_uniforms Billboard;
uniform int billboard_mode : hint_enum(\"Disabled\", \"Enabled\", \"Y-Billboard\") = 0;

group_uniforms Outline_Options;
uniform bool no_outlines = false;

// --- DITHERING STYLE ---
group_uniforms Dithering_Style;
uniform int dither_type : hint_enum(\"Bayer 8x8\", \"Bayer 4x4\", \"Blue Noise\", \"White Noise\", \"Diffused\") = 0;
uniform int dither_mode : hint_enum(\"Object UV\", \"Screen Space\", \"World Space\") = 2;
// How \"chunky\" the pixels are
uniform float dither_pixel_size : hint_range(1.0, 8.0) = 2.0;
// How dense the grid is (Higher = smaller dots)
uniform float dither_density = 2048.0;
uniform float world_dither_density = 32.0;
// Smoothness of the gradient (0.01 = Hard Cut, 0.5 = Smooth Fade)
uniform float dither_spread : hint_range(0.01, 2.0) = 0.5;
uniform float shadow_bias : hint_range(-1.0, 1.0) = 0.0;
uniform sampler2D blue_noise_texture : hint_default_white, filter_nearest, repeat_enable;

group_uniforms Texture_Controls;
uniform int albedo_mapping : hint_enum(\"Object UV\", \"World Space\") = 0;
uniform vec2 uv_scale = vec2(1.0, 1.0);
uniform vec2 uv_offset = vec2(0.0, 0.0);

group_uniforms Lighting;
uniform vec3 global_ambient : source_color = vec3(0.1, 0.1, 0.1);
uniform float light_boost : hint_range(1.0, 100.0) = 2.0;

group_uniforms Bounce_Lighting;
uniform float bounce_strength : hint_range(0.0, 5.0) = 0.5;

// --- VARYINGS ---
varying vec3 v_world_pos;
varying vec3 v_world_norm;

void vertex() {
	if (billboard_mode == 1) { // Enabled
		MODELVIEW_MATRIX = VIEW_MATRIX * mat4(
			INV_VIEW_MATRIX[0],
			INV_VIEW_MATRIX[1],
			INV_VIEW_MATRIX[2],
			MODEL_MATRIX[3]
		);

		// Restore scaling
		vec3 scale = vec3(length(MODEL_MATRIX[0]), length(MODEL_MATRIX[1]), length(MODEL_MATRIX[2]));
		MODELVIEW_MATRIX[0] *= scale.x;
		MODELVIEW_MATRIX[1] *= scale.y;
		MODELVIEW_MATRIX[2] *= scale.z;

		// Re-calculate world position and normal for dithering
		mat4 model_matrix = INV_VIEW_MATRIX * MODELVIEW_MATRIX;
		v_world_pos = (model_matrix * vec4(VERTEX, 1.0)).xyz;
		v_world_norm = mat3(model_matrix) * NORMAL;
	} else if (billboard_mode == 2) { // Y-Billboard
		vec3 scale = vec3(length(MODEL_MATRIX[0]), length(MODEL_MATRIX[1]), length(MODEL_MATRIX[2]));

		vec3 cam_pos = INV_VIEW_MATRIX[3].xyz;
		vec3 obj_pos = MODEL_MATRIX[3].xyz;
		vec3 target = cam_pos - obj_pos;
		target.y = 0.0; // Project to XZ plane

		if (length(target) > 0.001) {
			target = normalize(target);
			vec3 up = vec3(0.0, 1.0, 0.0);
			vec3 right = normalize(cross(up, target));

			// Construct rotation matrix
			mat4 rot_mat = mat4(
				vec4(right * scale.x, 0.0),
				vec4(up * scale.y, 0.0),
				vec4(target * scale.z, 0.0),
				vec4(MODEL_MATRIX[3].xyz, 1.0)
			);

			MODELVIEW_MATRIX = VIEW_MATRIX * rot_mat;

			v_world_pos = (rot_mat * vec4(VERTEX, 1.0)).xyz;
			v_world_norm = mat3(rot_mat) * NORMAL;
		} else {
			v_world_pos = (MODEL_MATRIX * vec4(VERTEX, 1.0)).xyz;
			v_world_norm = MODEL_NORMAL_MATRIX * NORMAL;
		}
	} else {
		v_world_pos = (MODEL_MATRIX * vec4(VERTEX, 1.0)).xyz;
		v_world_norm = MODEL_NORMAL_MATRIX * NORMAL;
	}
}

// --- DITHER MAPPING ---

// Helper: Convert Color -> Brightness (Luminance)
float get_lum(vec3 color) {
	return dot(color, vec3(0.299, 0.587, 0.114));
}

float get_dither_noise(vec2 uv) {
	// Quantize the UVs (The \"Pixel\" Look)
	// We don't apply density here, as it's passed into UV before calling this function
	vec2 stepped_pos = floor(uv / dither_pixel_size);

	if (dither_type == 0) { // Bayer 8x8
		const int bayer8[64] = {
			0, 48, 12, 60, 3, 51, 15, 63,
			32, 16, 44, 28, 35, 19, 47, 31,
			8, 56, 4, 52, 11, 59, 7, 55,
			40, 24, 36, 20, 43, 27, 39, 23,
			2, 50, 14, 62, 1, 49, 13, 61,
			34, 18, 46, 30, 33, 17, 45, 29,
			10, 58, 6, 54, 9, 57, 5, 53,
			42, 26, 38, 22, 41, 25, 37, 21
		};
		int x = int(mod(stepped_pos.x, 8.0));
		int y = int(mod(stepped_pos.y, 8.0));
		int idx = y * 8 + x;
		return float(bayer8[idx]) / 64.0;
	}
	else if (dither_type == 1) { // Bayer 4x4
		const int bayer4[16] = {
			0, 8, 2, 10,
			12, 4, 14, 6,
			3, 11, 1, 9,
			15, 7, 13, 5
		};
		int x = int(mod(stepped_pos.x, 4.0));
		int y = int(mod(stepped_pos.y, 4.0));
		int idx = y * 4 + x;
		return float(bayer4[idx]) / 16.0;
	}
	else if (dither_type == 2) { // Blue Noise
		vec2 tex_size = vec2(textureSize(blue_noise_texture, 0));
		if (tex_size.x <= 1.0) {
			// Fallback to Diffused (IGN) if no texture
			vec3 magic = vec3(0.06711056, 0.00583715, 52.9829189);
			return fract(magic.z * fract(dot(stepped_pos, magic.xy)));
		}
		// Use texture repeat
		vec2 tex_uv = stepped_pos / tex_size;
		return texture(blue_noise_texture, tex_uv).r;
	}
	else if (dither_type == 3) { // White Noise
		return fract(sin(dot(stepped_pos, vec2(12.9898, 78.233))) * 43758.5453);
	}
	else { // Diffused (IGN) - dither_type == 4 or default
		vec3 magic = vec3(0.06711056, 0.00583715, 52.9829189);
		return fract(magic.z * fract(dot(stepped_pos, magic.xy)));
	}
}

float quantize_value(float lum, float noise) {
	float bands = max(2.0, color_depth);
	float noise_scaled = (noise - 0.5) * dither_spread / (bands - 1.0);
	float val = lum + noise_scaled + shadow_bias;
	val = clamp(val, 0.0, 1.0);
	val = floor(val * bands);
	val = clamp(val, 0.0, bands - 1.0);
	val /= (bands - 1.0);
	return val;
}

void fragment() {
	// Culling
	if ((cull_mode == 0 && !FRONT_FACING) || (cull_mode == 1 && FRONT_FACING)) {
		discard;
	}

	// 0. Texture Read with Scale/Offset
	vec2 uv = UV * uv_scale + uv_offset;
	vec4 tex;
	if (albedo_mapping == 1) { // World Space
		vec3 world_norm = normalize(v_world_norm);
		vec3 blend = abs(world_norm);
		blend /= (blend.x + blend.y + blend.z);

		vec4 x_tex = texture(texture_albedo, v_world_pos.zy * uv_scale + uv_offset);
		vec4 y_tex = texture(texture_albedo, v_world_pos.xz * uv_scale + uv_offset);
		vec4 z_tex = texture(texture_albedo, v_world_pos.xy * uv_scale + uv_offset);

		tex = x_tex * blend.x + y_tex * blend.y + z_tex * blend.z;
	} else { // Object UV
		tex = texture(texture_albedo, uv);
	}
	vec3 base_color = tex.rgb;

	NORMAL_MAP = texture(texture_normal, uv).rgb;
	NORMAL_MAP_DEPTH = normal_scale;

	if (use_transparency && tex.a < alpha_threshold) {
		discard;
	}

	// 1. Get Brightness
	float texture_brightness = get_lum(base_color);

	// --- AMBIENT PASS ---
	float ambient_brightness = get_lum(global_ambient);

	// Bounce Light
	vec3 world_normal = normalize(v_world_norm);
	float bounce_factor = clamp(-world_normal.y * 0.5 + 0.5, 0.0, 1.0);
	bounce_factor = pow(bounce_factor, 2.0);
	float bounce_lum = bounce_strength * bounce_factor;

	float total_ambient_lum = (ambient_brightness + bounce_lum) * texture_brightness;

	// 2. Dither Calculation
	vec2 dither_uv;
	if (dither_mode == 0) { // Object UV
		dither_uv = uv;
	} else if (dither_mode == 1) { // Screen Space
		dither_uv = SCREEN_UV;
	} else { // World Space
		// Triplanar Mapping
		vec3 world_norm = normalize(v_world_norm);
		vec3 blend = abs(world_norm);
		blend /= (blend.x + blend.y + blend.z);
		if (blend.x > blend.y && blend.x > blend.z) {
			 dither_uv = v_world_pos.zy;
		} else if (blend.y > blend.z) {
			 dither_uv = v_world_pos.xz;
		} else {
			 dither_uv = v_world_pos.xy;
		}
	}

	float density = (dither_mode == 2) ? world_dither_density : dither_density;
	// Pre-scale UV by density before passing to noise function
	float noise_val = get_dither_noise(dither_uv * density);

	if (use_dithered_transparency) {
		float alpha = tex.a * opacity;
		if (alpha <= 0.0 || alpha < noise_val) {
			discard;
		}
	}

	// Pass dither noise in METALLIC for light().
	// SPECULAR is not available in light(), so we use METALLIC which is unused.
	METALLIC = noise_val;
	SPECULAR = 0.0;

	float r = texture(texture_roughness, uv).r * roughness_scale;
	ROUGHNESS = r;

	// 4. Output Logic
	vec3 final_albedo;
	float val = quantize_value(total_ambient_lum, noise_val);

	if (use_gradient) {
		float gradient_val = use_inverse_gradient ? 1.0 - val : val;
		final_albedo = texture(color_gradient, vec2(gradient_val, 0.0)).rgb;
	} else {
		final_albedo = mix(shadow_color, base_color * lit_color, val);
	}

	ALBEDO = vec3(0.0);
	EMISSION = final_albedo;
}

void light() {
	// 0. Texture Read
	vec4 tex;
	if (albedo_mapping == 1) { // World Space
		vec3 world_norm = normalize(v_world_norm);
		vec3 blend = abs(world_norm);
		blend /= (blend.x + blend.y + blend.z);

		vec4 x_tex = texture(texture_albedo, v_world_pos.zy * uv_scale + uv_offset);
		vec4 y_tex = texture(texture_albedo, v_world_pos.xz * uv_scale + uv_offset);
		vec4 z_tex = texture(texture_albedo, v_world_pos.xy * uv_scale + uv_offset);

		tex = x_tex * blend.x + y_tex * blend.y + z_tex * blend.z;
	} else { // Object UV
		vec2 uv = UV * uv_scale + uv_offset;
		tex = texture(texture_albedo, uv);
	}
	vec3 base_color = tex.rgb;
	float texture_brightness = get_lum(base_color);

	// 1. Dither Calculation - Reuse from Fragment
	float noise_val = METALLIC;

	// 2. Calculate Dynamic Light Brightness
	float NdotL = max(0.0, dot(NORMAL, LIGHT));
	vec3 light_intensity = LIGHT_COLOR * NdotL * ATTENUATION * light_boost;
	float light_brightness = get_lum(light_intensity);

	// 3. Combined Brightness
	float total_lum = light_brightness * texture_brightness;

	// 4. Add Light
	float val = quantize_value(total_lum, noise_val);

	if (use_gradient) {
		float gradient_pos = use_inverse_gradient ? 1.0 - val : val;
		vec3 lit_c = texture(color_gradient, vec2(gradient_pos, 0.0)).rgb;
		SPECULAR_LIGHT += lit_c;
	} else {
		SPECULAR_LIGHT += mix(vec3(0.0), base_color * lit_color, val);
	}
}
"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_2bkw1"]
render_priority = 0
shader = SubResource("Shader_wjrvc")
shader_parameter/texture_albedo = ExtResource("8_pk8ii")
shader_parameter/lit_color = Color(0.5609555, 0.56095475, 0.5609549, 1)
shader_parameter/normal_scale = 1.0
shader_parameter/shadow_color = Color(0.18717626, 0.18717608, 0.18717623, 1)
shader_parameter/use_gradient = false
shader_parameter/use_inverse_gradient = false
shader_parameter/color_depth = 16.0000007125
shader_parameter/roughness_scale = 1.0
shader_parameter/use_transparency = true
shader_parameter/alpha_threshold = 0.2010000095475
shader_parameter/cull_mode = 2
shader_parameter/use_dithered_transparency = true
shader_parameter/opacity = 0.43600002071
shader_parameter/billboard_mode = 2
shader_parameter/no_outlines = true
shader_parameter/dither_type = 2
shader_parameter/dither_mode = 0
shader_parameter/dither_pixel_size = 2.0
shader_parameter/dither_density = 64.0
shader_parameter/world_dither_density = 64.0
shader_parameter/dither_spread = 0.91500004276398
shader_parameter/shadow_bias = 0.06400005054000002
shader_parameter/blue_noise_texture = ExtResource("6_iqsei")
shader_parameter/albedo_mapping = 0
shader_parameter/uv_scale = Vector2(1, 1)
shader_parameter/uv_offset = Vector2(0, 0)
shader_parameter/global_ambient = Color(0, 0.014809188, 0.015851432, 1)
shader_parameter/light_boost = 1.0
shader_parameter/bounce_strength = 0.0

[sub_resource type="ParticleProcessMaterial" id="ParticleProcessMaterial_etrdt"]
lifetime_randomness = 0.5
emission_shape = 1
emission_sphere_radius = 0.06
angle_min = -720.0
angle_max = 720.0
radial_velocity_min = -0.050022352
radial_velocity_max = 0.049977645
gravity = Vector3(0, 0.25, 0)
tangential_accel_min = -0.050002236
tangential_accel_max = 0.04999776
scale_min = 0.0
scale_max = 0.25
scale_over_velocity_max = 10.0
scale_over_velocity_curve = SubResource("CurveTexture_o1df0")
turbulence_noise_speed_random = 0.77
turbulence_influence_max = 0.149
collision_mode = 1
collision_friction = 1.0
collision_bounce = 1.0
collision_use_scale = true

[sub_resource type="QuadMesh" id="QuadMesh_x1r1x"]

[sub_resource type="QuadMesh" id="QuadMesh_21l5o"]
orientation = 1

[sub_resource type="QuadMesh" id="QuadMesh_2bkw1"]
orientation = 0

[sub_resource type="CapsuleMesh" id="CapsuleMesh_6agyq"]
radial_segments = 16
rings = 2

[sub_resource type="CapsuleShape3D" id="CapsuleShape3D_8xumb"]

[sub_resource type="AudioStreamRandomizer" id="AudioStreamRandomizer_ioxgp"]
random_pitch = 1.1892071
random_volume_offset_db = 3.0
streams_count = 4
stream_0/stream = ExtResource("16_lgqa7")
stream_1/stream = ExtResource("17_8ydkj")
stream_2/stream = ExtResource("18_3j4b4")
stream_3/stream = ExtResource("19_yj68g")

[sub_resource type="ShaderMaterial" id="ShaderMaterial_lgqa7"]

[sub_resource type="FastNoiseLite" id="FastNoiseLite_kvlxm"]
frequency = 0.3574
fractal_octaves = 10

[sub_resource type="NoiseTexture2D" id="NoiseTexture2D_gis51"]
noise = SubResource("FastNoiseLite_kvlxm")

[sub_resource type="Gradient" id="Gradient_uf5tr"]
interpolation_mode = 1
offsets = PackedFloat32Array(0)
colors = PackedColorArray(0, 0.014809188, 0.015851432, 1)

[sub_resource type="GradientTexture1D" id="GradientTexture1D_0bhws"]
gradient = SubResource("Gradient_uf5tr")
width = 1

[sub_resource type="ShaderMaterial" id="ShaderMaterial_8ydkj"]
shader = ExtResource("16_myrg7")
shader_parameter/pixel_size = 2.0000000475
shader_parameter/use_screen_texture = false
shader_parameter/use_dithering = true
shader_parameter/dither_type = 4
shader_parameter/dither_mode = 0
shader_parameter/dither_size = 4.000000142499999
shader_parameter/dither_amount = 1.0
shader_parameter/blue_noise_texture = SubResource("NoiseTexture2D_gis51")
shader_parameter/use_transparency = false
shader_parameter/alpha_threshold = 0.5
shader_parameter/use_dithered_transparency = true
shader_parameter/opacity = 1.0
shader_parameter/color_depth = 5.00000019
shader_parameter/use_gradient = true
shader_parameter/color_gradient = SubResource("GradientTexture1D_0bhws")
shader_parameter/gradient_mix = 1.0
shader_parameter/inv_view_matrix = Projection(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1)
shader_parameter/inv_proj_matrix = Projection(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1)
shader_parameter/world_dither_density = 32.0

[sub_resource type="Animation" id="Animation_kvlxm"]
resource_name = "fade_out"
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath(".:material:shader_parameter/opacity")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 1),
"transitions": PackedFloat32Array(1, 1),
"update": 0,
"values": [1.0, 0.0]
}

[sub_resource type="AnimationLibrary" id="AnimationLibrary_uf5tr"]
_data = {
&"fade_out": SubResource("Animation_kvlxm")
}

[node name="player" type="CharacterBody3D" unique_id=1570651658 node_paths=PackedStringArray("step", "camera")]
axis_lock_angular_x = true
axis_lock_angular_y = true
axis_lock_angular_z = true
floor_constant_speed = true
floor_snap_length = 0.5
script = ExtResource("1_rkuj1")
maximum_speed = 10.0
jump_height = 2.5
step = NodePath("steps")
camera = NodePath("head/lean/camera")

[node name="WorldEnvironment" type="WorldEnvironment" parent="." unique_id=444993200]
environment = SubResource("Environment_ugbui")

[node name="head" type="Node3D" parent="." unique_id=951371490]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.5, 0)

[node name="lean" type="Node3D" parent="head" unique_id=1019706298]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -0.5, 0)

[node name="camera" type="Camera3D" parent="head/lean" unique_id=1055946145 node_paths=PackedStringArray("cam", "head", "lean")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.5, 0)
cull_mask = 1048573
fov = 90.0
far = 100000.0
script = ExtResource("2_qek5x")
cam = NodePath(".")
head = NodePath("../..")
lean = NodePath("..")
bob_interval = 1.5

[node name="pixelate" parent="head/lean/camera" unique_id=93580127 instance=ExtResource("5_kvlxm")]

[node name="embers" type="GPUParticles3D" parent="head/lean/camera" unique_id=1607288932]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -0.63, 0.198, -0.625)
sorting_offset = 5.0
material_override = SubResource("ShaderMaterial_gybtl")
cast_shadow = 0
amount = 32
lifetime = 3.0
fixed_fps = 24
process_material = SubResource("ParticleProcessMaterial_21l5o")
draw_pass_1 = SubResource("QuadMesh_wjrvc")

[node name="smoke" type="GPUParticles3D" parent="head/lean/camera" unique_id=1786560102]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -0.63, 0.198, -0.625)
material_override = SubResource("ShaderMaterial_2bkw1")
cast_shadow = 0
amount = 5000
lifetime = 60.0
randomness = 0.15
fixed_fps = 144
process_material = SubResource("ParticleProcessMaterial_etrdt")
draw_passes = 3
draw_pass_1 = SubResource("QuadMesh_x1r1x")
draw_pass_2 = SubResource("QuadMesh_21l5o")
draw_pass_3 = SubResource("QuadMesh_2bkw1")

[node name="GPUParticlesCollisionBox3D" type="GPUParticlesCollisionBox3D" parent="head/lean/camera" unique_id=125074614]
size = Vector3(50, 50, 50)

[node name="mesh" type="MeshInstance3D" parent="." unique_id=295009724]
layers = 4
material_override = ExtResource("2_h17s1")
mesh = SubResource("CapsuleMesh_6agyq")

[node name="collision" type="CollisionShape3D" parent="." unique_id=1018871596]
shape = SubResource("CapsuleShape3D_8xumb")

[node name="steps" type="AudioStreamPlayer3D" parent="." unique_id=59331114]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -0.854739, 0)
stream = SubResource("AudioStreamRandomizer_ioxgp")
bus = &"steps"
script = ExtResource("20_8ydkj")

[node name="Timer" type="Timer" parent="steps" unique_id=458050395]
process_callback = 0

[node name="logic" type="Node" parent="." unique_id=717132806]

[node name="input_gather" type="Node" parent="logic" unique_id=1968179394]
script = ExtResource("2_0owmy")

[node name="move" type="Node" parent="logic" unique_id=327719302 node_paths=PackedStringArray("initial_state")]
script = ExtResource("5_5tt2p")
initial_state = NodePath("idle")
metadata/_custom_type_script = "uid://dlyn7myxb1v18"

[node name="idle" type="Node" parent="logic/move" unique_id=739972491 node_paths=PackedStringArray("player")]
script = ExtResource("6_rkuj1")
player = NodePath("../../..")
metadata/_custom_type_script = "uid://bs6sc1frb1nfc"

[node name="walk" type="Node" parent="logic/move" unique_id=1904536783 node_paths=PackedStringArray("player")]
script = ExtResource("7_ers80")
player = NodePath("../../..")
metadata/_custom_type_script = "uid://b01bw7djd0wvp"

[node name="jump" type="Node" parent="logic/move" unique_id=1340535446 node_paths=PackedStringArray("player")]
script = ExtResource("8_nwn0c")
player = NodePath("../../..")
metadata/_custom_type_script = "uid://dmw47mb382ebt"

[node name="fall" type="Node" parent="logic/move" unique_id=1236452360 node_paths=PackedStringArray("player")]
script = ExtResource("9_y4pjd")
player = NodePath("../../..")
metadata/_custom_type_script = "uid://brdohbduwyyb6"

[node name="crouch" type="Node" parent="logic/move" unique_id=1066699845 node_paths=PackedStringArray("player")]
script = ExtResource("12_lgqa7")
player = NodePath("../../..")
metadata/_custom_type_script = "uid://vptqvkhe206v"

[node name="run" type="Node" parent="logic/move" unique_id=1994246396 node_paths=PackedStringArray("player")]
script = ExtResource("18_cnsyf")
player = NodePath("../../..")
metadata/_custom_type_script = "uid://bdnt7gg01aapm"

[node name="SubViewportContainer" type="SubViewportContainer" parent="." unique_id=897390686]
texture_filter = 1
material = SubResource("ShaderMaterial_lgqa7")
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
mouse_filter = 2

[node name="hand_view" type="SubViewport" parent="SubViewportContainer" unique_id=476380750]
transparent_bg = true
handle_input_locally = false
canvas_item_default_texture_filter = 0
size = Vector2i(960, 540)
render_target_update_mode = 4

[node name="camera" type="Camera3D" parent="SubViewportContainer/hand_view" unique_id=1232050989 node_paths=PackedStringArray("node_to_match")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.5, 0)
cull_mask = 1047554
fov = 90.0
far = 1000000.0
script = ExtResource("6_fm80t")
node_to_match = NodePath("../../../head/lean/camera")

[node name="sway" type="Node3D" parent="SubViewportContainer/hand_view" unique_id=568651731 node_paths=PackedStringArray("player", "camera", "holder")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.5, 0)
script = ExtResource("3_ioxgp")
player = NodePath("../../..")
camera = NodePath("../camera")
holder = NodePath("holder")

[node name="holder" type="Node3D" parent="SubViewportContainer/hand_view/sway" unique_id=567501717]

[node name="torch" type="Node3D" parent="SubViewportContainer/hand_view/sway/holder" unique_id=1298538801]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.5, 0)

[node name="torch" parent="SubViewportContainer/hand_view/sway/holder/torch" unique_id=1836886530 instance=ExtResource("19_ioxgp")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -0.61, -0.495, -0.59)

[node name="Cylinder" parent="SubViewportContainer/hand_view/sway/holder/torch/torch" index="0" unique_id=1062861853]
layers = 2

[node name="Cylinder_001" parent="SubViewportContainer/hand_view/sway/holder/torch/torch" index="1" unique_id=1062649697]
layers = 2

[node name="Cylinder_002" parent="SubViewportContainer/hand_view/sway/holder/torch/torch" index="2" unique_id=838068679]
layers = 2

[node name="Cylinder_003" parent="SubViewportContainer/hand_view/sway/holder/torch/torch" index="3" unique_id=1397636730]
layers = 2

[node name="OmniLight3D" parent="SubViewportContainer/hand_view/sway/holder/torch/torch" index="4" unique_id=592766888]
layers = 2
light_energy = 2.4344506
shadow_blur = 1.47378

[node name="Sprite3D2" parent="SubViewportContainer/hand_view/sway/holder/torch/torch/OmniLight3D" index="0" unique_id=1329841238]
layers = 2

[node name="Sprite3D3" parent="SubViewportContainer/hand_view/sway/holder/torch/torch/OmniLight3D" index="1" unique_id=1148831848]
transform = Transform3D(-0.94531393, 0, -0.32616046, 0, 0.51436794, 0, 0.32616046, 0, -0.94531393, 0, -0.05956757, 0.00080662966)
layers = 2
frame = 3

[node name="Sprite3D4" parent="SubViewportContainer/hand_view/sway/holder/torch/torch/OmniLight3D" index="2" unique_id=1923378448]
transform = Transform3D(-0.6362338, 0, 0.77149594, 0, 0.51436794, 0, -0.77149594, 0, -0.6362338, 0, -0.05956757, 0.00080662966)
layers = 2

[node name="embers" parent="SubViewportContainer/hand_view/sway/holder/torch/torch/OmniLight3D" index="3" unique_id=2084859198]
visible = false
layers = 2

[node name="smoke" parent="SubViewportContainer/hand_view/sway/holder/torch/torch/OmniLight3D" index="4" unique_id=2081439854]
visible = false
layers = 2

[node name="chalk" parent="SubViewportContainer/hand_view/sway/holder" unique_id=1123505354 instance=ExtResource("22_cnsyf")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.5, 0)

[node name="CanvasLayer" type="CanvasLayer" parent="." unique_id=650718009]

[node name="Control" type="ColorRect" parent="CanvasLayer" unique_id=485828585]
material = ExtResource("15_fcs02")
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
mouse_filter = 2
script = ExtResource("23_canvas_dither")
camera_path = NodePath("../../head/lean/camera")
metadata/_edit_use_anchors_ = true

[node name="dither_trans" type="ColorRect" parent="CanvasLayer" unique_id=2018062212]
modulate = Color(0, 0, 0, 1)
self_modulate = Color(0, 0, 0, 1)
material = SubResource("ShaderMaterial_8ydkj")
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
mouse_filter = 2
color = Color(0, 0, 0, 1)
metadata/_edit_use_anchors_ = true

[node name="AnimationPlayer" type="AnimationPlayer" parent="CanvasLayer/dither_trans" unique_id=210986631]
libraries/ = SubResource("AnimationLibrary_uf5tr")

[editable path="SubViewportContainer/hand_view/sway/holder/torch/torch"]
[editable path="SubViewportContainer/hand_view/sway/holder/chalk"]
[editable path="SubViewportContainer/hand_view/sway/holder/chalk/chalk"]
